apiVersion: argoproj.io/v1alpha1
kind: EventSource
metadata:
  name: minio
spec:
  minio:
    geoparquet:
      accessKey:
        key: access-key
        name: artifacts-minio
      bucket:
        name: geoparquet
      endpoint: minio.gis-team.svc.cluster.local:11000
      events:
        - s3:ObjectCreated:Put
      insecure: true
      secretKey:
        key: secret-key
        name: artifacts-minio
      filter:
        suffix: ".parquet"

---
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: minio-sensor
spec:
  dependencies:
    - eventName: geoparquet
      eventSourceName: minio
      name: geoparquet
  triggers:
    - template:
        name: minio-sensor-trigger
        argoWorkflow:
          operation: submit
          parameters:
            - dest: spec.arguments.parameters.0.value  # Fixed typo: paramaters -> parameters
              src:
                dataKey: notification.0.s3.object.key
                dependencyName: geoparquet
          source:
            resource:  # Removed duplicate 'source' key
              apiVersion: argoproj.io/v1alpha1
              kind: Workflow
              metadata:
                generateName: spark-create-iceberg-workflow-
                namespace: team-gis
              spec:
                arguments: { }
                entrypoint: sparkapp-operator
                templates:
                  - name: sparkapp-operator
                    resource:
                      action: create
                      manifest: |
                        apiVersion: "sparkoperator.k8s.io/v1beta2"
                        kind: SparkApplication
                        metadata:
                          generateName: spark-
                          namespace: team-gis
                        spec:
                          type: Java
                          mode: cluster
                          image: ghcr.io/sbylemas/spark-create-iceberg:latest
                          imagePullPolicy: Always
                          mainClass: be.bylemans.Main
                          mainApplicationFile:  local:///opt/spark/spark-create-iceberg.jar
                          sparkVersion: "3.5.7"
                          driver:
                            cores: 1
                            coreLimit: "1200m"
                            memory: "512m"
                            serviceAccount: spark
                            labels:
                              version: 3.1.1
                          executor:
                            cores: 1
                            instances: 1
                            memory: "512m"
                            labels:
                              version: 3.1.1
                          hadoopConf:
                            fs.s3.connection.timeout=6000
                            fs.s3.endpoint=http://minio:11000
                            fs.s3.access.key=local-access
                            fs.s3.secret.key=local-secret
                            fs.s3.path.style.access=true
                            fs.s3.impl=org.apache.hadoop.fs.s3a.S3AFileSystem
                            fs.s3.aws.credentials.provider=org.apache.hadoop.fs.s3a.SimpleAWSCredentialsProvider
                          sparkConf:
